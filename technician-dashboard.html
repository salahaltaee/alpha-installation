<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ - ALPHA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h3 class="mb-3">ğŸ§° Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ</h3>
    <p>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <strong class="text-primary">9647840400214</strong></p>

    <h4>ğŸ“¥ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h4>
    <div id="newOrders" class="mb-5"></div>

    <h4>ğŸŸ¡ Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„</h4>
    <div id="inProgressOrders" class="mb-5"></div>

    <h4>âœ… Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h4>
    <div id="completedOrders" class="mb-5"></div>

    <h5 class="text-end mt-5">
      ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±:
      <span id="totalMonthly" class="text-success fw-bold">0 Ø¯.Ø¹</span>
    </h5>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyClDmGw0rvjq5YcNkFVXjy9JYPKZlCq4Bw",
      authDomain: "alpha-installation.firebaseapp.com",
      projectId: "alpha-installation"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const salesWhatsapp = "9647840400214";
    let totalIncome = 0;
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();

    auth.onAuthStateChanged(async (user) => {
      if (!user) return window.location.href = "login-technician.html";

      const userDoc = await db.collection("users").doc(user.uid).get();
      const technicianName = userDoc.data().name;

      db.collection("orders").where("technicianId", "==", user.uid).onSnapshot(snapshot => {
        document.getElementById("newOrders").innerHTML = "";
        document.getElementById("inProgressOrders").innerHTML = "";
        document.getElementById("completedOrders").innerHTML = "";
        totalIncome = 0;

        snapshot.forEach(doc => {
          const data = doc.data();
          const id = doc.id;
          const createdAt = data.createdAt?.toDate();
          const formattedDate = createdAt ? createdAt.toLocaleDateString("ar-EG") : "ØºÙŠØ± Ù…ØªÙˆÙØ±";
          const status = data.status || "Ø¬Ø¯ÙŠØ¯";
          const installPrice = data.installPrice || 0;

          const msgToCustomer = `Ù…Ø±Ø­Ø¨Ø§ Ø£Ø³ØªØ§Ø° ${data.customerName}ØŒ Ø£Ù†Ø§ Ø§Ù„ÙÙ†ÙŠ ${technicianName} Ù…Ù† Ø´Ø±ÙƒØ© ALPHAØŒ Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ† ØªØ±Ø³Ù„ Ù„ÙŠ Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù† ÙˆÙ…ØªÙ‰ Ù…Ù†Ø§Ø³Ø¨ Ù„ÙƒØŸ`;

          const card = `
            <div class="card mb-3 shadow-sm">
              <div class="card-body">
                <h5>${data.customerName}</h5>
                <p>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${data.customerAddress}</p>
                <p>ğŸ” Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙÙ„: ${data.lockType}</p>
                <p>ğŸ“† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø¯: ${formattedDate}</p>
                <p>ğŸ’¸ Ø³Ø¹Ø± Ø§Ù„Ø´Ø¯: <strong>${installPrice} Ø¯.Ø¹</strong></p>
                <p>Ø§Ù„Ø­Ø§Ù„Ø©: <strong>${status}</strong></p>

                <div class="d-flex flex-wrap gap-2 mt-2">
                  ${status === "Ø¬Ø¯ÙŠØ¯" ? `<button class="btn btn-sm btn-primary" onclick="approveOrder('${id}')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>` : ""}
                  ${status === "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„ÙÙ†ÙŠ" ? `
                    <button class="btn btn-sm btn-outline-success" onclick="sendWhatsAppAndEnable('${id}', '${data.customerName}')">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                    <button id="finishBtn-${id}" class="btn btn-sm btn-danger" disabled onclick="markCompleted('${id}')">âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„</button>
                  ` : ""}
                  <a class="btn btn-sm btn-outline-info" target="_blank" href="https://wa.me/${data.customerPhone}?text=${encodeURIComponent(msgToCustomer)}">ğŸ“© ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø²Ø¨ÙˆÙ†</a>
                </div>
              </div>
            </div>
          `;

          if (status === "Ø¬Ø¯ÙŠØ¯") {
            document.getElementById("newOrders").innerHTML += card;
          } else if (status === "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„ÙÙ†ÙŠ") {
            document.getElementById("inProgressOrders").innerHTML += card;
          } else if (status === "ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„ÙÙ†ÙŠ") {
            const date = createdAt;
            if (date && date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
              totalIncome += installPrice;
            }
            document.getElementById("completedOrders").innerHTML += card;
          }
        });

        document.getElementById("totalMonthly").innerText = totalIncome.toLocaleString() + " Ø¯.Ø¹";
      });
    });

    function approveOrder(id) {
      db.collection("orders").doc(id).update({
        status: "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„ÙÙ†ÙŠ"
      });
      alert("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© âœ…");
    }

    function markCompleted(id) {
      db.collection("orders").doc(id).update({
        status: "ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„ÙÙ†ÙŠ"
      });
      alert("ğŸ‰ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
    }

    function sendWhatsAppAndEnable(id, customerName) {
      const msg = `Ø§ØªÙ…Ù…Øª Ø¹Ù…Ù„ÙŠ ÙˆÙ‡Ø°Ù‡ Ø¹Ù…Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø° ${customerName} ÙˆØ³Ø£Ø±Ø³Ù„ Ø§Ù„ØµÙˆØ± Ù„Ù„Ø¹Ù…Ù„`;
      const link = `https://wa.me/${salesWhatsapp}?text=${encodeURIComponent(msg)}`;
      window.open(link, "_blank");

      setTimeout(() => {
        const btn = document.getElementById(`finishBtn-${id}`);
        if (btn) {
          btn.disabled = false;
          btn.classList.remove("btn-danger");
          btn.classList.add("btn-success");
        }
      }, 2000); // Ù…Ù‡Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    }
  </script>
</body>
</html>
